{% extends 'base.html' %}

{% block content %}

<!-- ì´ê±° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„£ì–´ì•¼ ì¢‹ì•„ìš” í•˜íŠ¸ê°€ ë˜ë”ë¼êµ¬ìš”...-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
  .custom-card {
    max-width: 600px; /* ì¹´ë“œì˜ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
    margin: auto; /* ê°€ìš´ë° ì •ë ¬ */
  }
  .feed-image {
    object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë®ê¸° */
    max-height: 500px; /* ì´ë¯¸ì§€ì˜ ìµœëŒ€ ë†’ì´ ì„¤ì • */
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  .comment {
    margin-bottom: 20px;
  }
  .comment-content.collapsed {
    display: none;
  }
  /* ëŒ“ê¸€ ì…ë ¥ í…ìŠ¤íŠ¸ ì°½ ìŠ¤íƒ€ì¼ */
  .comment-input {
    width: 100%; /* ê°€ë¡œí­ì„ ìµœëŒ€í•œ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    padding: 10px; /* ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
    border: 1px solid #ced4da; /* í…Œë‘ë¦¬ ì„¤ì • */
    border-radius: 5px; /* í…Œë‘ë¦¬ë¥¼ ë‘¥ê¸€ê²Œ ë§Œë“¦ */
    resize: none; /* ìˆ˜ì§ìœ¼ë¡œë§Œ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
    min-height: 100px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
    font-size: 16px; /* ê¸€ê¼´ í¬ê¸° ì„¤ì • */   
  }

  /* ì…ë ¥ í…ìŠ¤íŠ¸ ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œ í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
  .comment-input:focus {
    border-color: #80bdff; /* í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œì˜ í…Œë‘ë¦¬ ìƒ‰ìƒ ì„¤ì • */
    outline: 0; /* ê¸°ë³¸ í¬ì»¤ìŠ¤ íš¨ê³¼ ì œê±° */
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œì˜ í…Œë‘ë¦¬ íš¨ê³¼ ì„¤ì • */
  }
</style>

<div class="container mt-5">
    <div class="card custom-card">

      <div class="card-body">
        {% if post.feed_images.all %}
          <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
            <div class="carousel-inner">
              {% for image in post.feed_images.all %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        {% endif %}
        
        <div class="card-body">
            <h2><a href="{% url 'feed:view_user' post.user.id %}">{{ post.user.username }}</a></h2>
            <h2>{{ post.title }}</h2>
            <p class="mt-3">{{ post.body_text }}</p>
    
    
            {% if user in post.likes.all %}
              <a href="{% url 'feed:like_content' post.id %}" class="no-underline">â¤ï¸</a>
            {% else %}
              <a href="{% url 'feed:like_content' post.id %}" class="no-underline">ğŸ¤</a>
            {% endif %}
            : {{ post.likes.count }}
    
    
            {% if post.content_type == 'review' and post.product %}
              <hr>
              <h5>ì œí’ˆ ë¦¬ë·°</h5>
              <p>ì œí’ˆëª…: {{ post.product.name }}</p>
              <p>íŒë§¤ì: {{ post.seller.username }}</p>
            {% endif %}
          </div>
          <div class="card-footer text-muted">
            <p> {{ post.created_at|date:"Y-m-d H:i" }} </p>
          </div>

      <!-- ----------------- ì¶”ê°€------------------------------  -->
      <div class="card-footer">
        <!-- ì¢‹ì•„ìš”ê°€ ë§ì€ ëŒ“ê¸€ -->
        {% if most_liked_comment %}
            <div class="comment-container">
                <div class="comment-header">
                    <h6>{{ most_liked_comment.user.username }}</h6>
                    <div class="comment-actions row justify-content-between">
                        <div class="col-auto">
                            {% if request.user == most_liked_comment.user or request.user.is_staff %}
                                <form action="{% url 'feed:comments_delete' most_liked_comment.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link">ì‚­ì œ</button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            {% if request.user == most_liked_comment.user or request.user.is_staff %}
                                <a href="{% url 'feed:comments_update' most_liked_comment.pk %}" class="btn btn-secondary">ìˆ˜ì •</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p>{{ most_liked_comment.comment_text }}</p>
                <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                <div class="row justify-content-between align-items-center">
                    <div class="col-auto">
                        <button class="like-btn btn-primary" data-comment-id="{{ most_liked_comment.pk }}">
                            {% if request.user.is_authenticated %}
                                {% if request.user in most_liked_comment.likes.all %}
                                    <i class="fas fa-heart text-danger"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° -->
                                {% else %}
                                    <i class="far fa-heart text-secondary"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš° -->
                                {% endif %}
                            {% else %}
                                <i class="far fa-heart text-secondary"></i> <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                            {% endif %}
                        </button>
                    </div>
                    <div class="col-auto">
                        <span class="like-count">{{ most_liked_comment.likes.count }}</span> <!-- ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œ -->
                    </div>
                </div>
                <!-- ìˆ˜ì •ë˜ë©´ ìˆ˜ì •í‘œì‹œ ë‚˜íƒ€ëƒ„ -->
                <p class="comment-date">
                    ì‘ì„±ì¼ì‹œ: {{ most_liked_comment.created_at }}
                    {% if most_liked_comment.created_at != most_liked_comment.updated_at %}
                        (ìˆ˜ì •ë¨)
                    {% endif %}
                </p>
            </div>
        {% endif %}

        <!-- ë‚˜ë¨¸ì§€ ëŒ“ê¸€ë“¤ -->
        {% for comment in other_comments %}
            <div class="comment-container {% if forloop.counter > 1 %}hidden{% endif %}">
                <div class="comment-header">
                    <h6>{{ comment.user.username }}</h6>
                    <div class="comment-actions row justify-content-between">
                        <div class="col-auto">
                            {% if request.user == comment.user or request.user.is_staff %}
                                <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-link">ì‚­ì œ</button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            {% if request.user == comment.user or request.user.is_staff %}
                                <a href="{% url 'feed:comments_update' comment.pk %}" class="btn btn-secondary">ìˆ˜ì •</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p>{{ comment.comment_text }}</p>
                <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                <div class="row justify-content-between align-items-center">
                    <div class="col-auto">
                        <button class="like-btn" data-comment-id="{{ comment.pk }}">
                            {% if request.user.is_authenticated %}
                                {% if request.user in comment.likes.all %}
                                    <i class="fas fa-heart text-danger"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° -->
                                {% else %}
                                    <i class="far fa-heart text-secondary"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš° -->
                                {% endif %}
                            {% else %}
                                <i class="far fa-heart text-secondary"></i> <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                            {% endif %}
                        </button>
                    </div>
                    <div class="col-auto">
                        <span class="like-count">{{ comment.likes.count }}</span> <!-- ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œ -->
                    </div>
                </div>
                <!-- ìˆ˜ì •ë˜ë©´ ìˆ˜ì •í‘œì‹œ ë‚˜íƒ€ëƒ„ -->
                <p class="comment-date">
                    ì‘ì„±ì¼ì‹œ: {{ comment.created_at }}
                    {% if comment.created_at != comment.updated_at %}
                        (ìˆ˜ì •ë¨)
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    
        <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
        {% if other_comments|length > 1 %}
            <button id="load-more-btn" class="btn btn-primary mt-3">ë” ë³´ê¸°</button>
        {% endif %}
        
        <!-- ëŒ“ê¸€ ì…ë ¥ í…ìŠ¤íŠ¸ ì°½ --> 
        <form id="comment-form" action="{% url 'feed:comments_create' post.id %}" method="post">
            {% csrf_token %}
            <textarea class="form-control comment-input" id="comment-text" name="comment_text" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button type="submit" class="btn btn-primary mt-3">ì‘ì„±</button>
        </form>
        
    </div>
</div>

<!-- AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ ì¢‹ì•„ìš” ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” JavaScript ì½”ë“œ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì´ˆê¸°ì—ëŠ” ìˆ¨ê²¨ì§„ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë²„íŠ¼ì„ ë³´ì´ì§€ ì•Šê²Œ ì„¤ì •
        document.querySelectorAll('.hidden').forEach(function(comment) {
            comment.style.display = 'none';
        });

        // ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('load-more-btn').addEventListener('click', function() {
            // ìˆ¨ê²¨ì§„ ëŒ“ê¸€ì„ ë³´ì´ë„ë¡ ì„¤ì •
            document.querySelectorAll('.hidden').forEach(function(comment) {
                comment.style.display = 'block';
            });

            // ë”ë³´ê¸° ë²„íŠ¼ì„ ìˆ¨ê¹€
            this.style.display = 'none';
        });
        
        // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.querySelectorAll('.like-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                var commentId = this.getAttribute('data-comment-id');
                var likeCount = this.closest('.row').querySelector('.like-count');
                var heartIcon = this.querySelector('i'); // í•˜íŠ¸ ì•„ì´ì½˜

                // AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë¡œ ì¢‹ì•„ìš” ìš”ì²­ì„ ë³´ëƒ„
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/feed/comment_like/' + commentId + '/');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        // ì„œë²„ë¡œë¶€í„° ì¢‹ì•„ìš” ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ìœ¼ë©´ ì¢‹ì•„ìš” ìˆ«ìë¥¼ ì—…ë°ì´íŠ¸
                        likeCount.textContent = response.likes_count;
                        
                        // ì¢‹ì•„ìš” ë²„íŠ¼ì˜ ì•„ì´ì½˜ ë³€ê²½
                        if (response.liked) {
                            heartIcon.classList.remove('far'); // ë¹ˆ í•˜íŠ¸ í´ë˜ìŠ¤ ì œê±°
                            heartIcon.classList.add('fas');  // ì±„ì›Œì§„ í•˜íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
                            heartIcon.classList.add('text-danger'); // í•˜íŠ¸ ìƒ‰ìƒ ë³€ê²½
                        } else {
                            heartIcon.classList.remove('fas'); // ì±„ì›Œì§„ í•˜íŠ¸ í´ë˜ìŠ¤ ì œê±°
                            heartIcon.classList.add('far');  // ë¹ˆ í•˜íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
                            heartIcon.classList.remove('text-danger'); // í•˜íŠ¸ ìƒ‰ìƒ ì œê±°
                        }
                    } else {
                        console.error('Request failed. Error: ' + xhr.status);
                    }
                };
                xhr.send(JSON.stringify({}));
            });
        });
    });
</script>
{% endblock %}
