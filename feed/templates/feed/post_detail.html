{% extends 'base.html' %}

{% block content %}
<!-- ì´ê±° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„£ì–´ì•¼ ì¢‹ì•„ìš” í•˜íŠ¸ê°€ ë˜ë”ë¼êµ¬ìš”...-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
  .custom-card {
    max-width: 600px; /* ì¹´ë“œì˜ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
    margin: auto; /* ê°€ìš´ë° ì •ë ¬ */
  }
  .feed-image {
    object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë®ê¸° */
    max-height: 500px; /* ì´ë¯¸ì§€ì˜ ìµœëŒ€ ë†’ì´ ì„¤ì • */
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  
  .comment {
    margin-bottom: 20px;
  }
  .comment-content.collapsed {
    display: none;
  }
  .post-body.collapsed {
    max-height: 3em; /* ì„¸ ì¤„ë¡œ ì œí•œ */
    overflow: hidden; /* ì´ˆê³¼ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
}

.post-body.expand {
    max-height: none; /* ë‚´ìš© ì „ì²´ í‘œì‹œ */
}

</style>

<div class="container mt-5">
    <div class="card custom-card">

      <div class="card-body">
        {% if post.feed_images.all %}
          <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
            <div class="carousel-inner">
              {% for image in post.feed_images.all %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        {% endif %}
        
        <div class="card-body">
            <h2><a href="{% url 'feed:view_user' post.user.id %}">{{ post.user.username }}</a></h2>
            <h2>{{ post.title }}</h2>
            <p class="mt-3">{{ post.body_text }}</p>
    
            {% if user in post.likes.all %}
              <a href="{% url 'feed:like_content' post.id %}" class="no-underline">â¤ï¸</a>
            {% else %}
              <a href="{% url 'feed:like_content' post.id %}" class="no-underline">ğŸ¤</a>
            {% endif %}
            : {{ post.likes.count }}
    
            {% if post.content_type == 'review' and post.product %}
              <hr>
              <h5>ì œí’ˆ ë¦¬ë·°</h5>
              <p>ì œí’ˆëª…: {{ post.product.name }}</p>
              <p>íŒë§¤ì: {{ post.seller.username }}</p>
            {% endif %}
          </div>
          <div class="card-footer text-muted">
            <p> {{ post.created_at|date:"Y-m-d H:i" }} </p>
          </div>

      <!-- ----------------- ëª¨ë‹¬ ì‚¬ìš©í•˜ì—¬ ìœ„ì ¯ ìƒì„±------------------------------  -->
      <div class="modal fade" id="commentWidgetModal" tabindex="-1" aria-labelledby="commentWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="commentWidgetModalLabel">ëŒ“ê¸€({{comments_count}})</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card-body">
                    <h2><a href="{% url 'feed:view_user' post.user.id %}">{{ post.user.username }}</a></h2>
                    <h2>{{ post.title }}</h2>
                    <p class="mt-3 post-body collapsed">{{ post.body_text }}</p>
                    <!-- ê²Œì‹œë¬¼ ë‚´ìš©ì˜ ë”ë³´ê¸° ë²„íŠ¼ -->
                    <button class="btn btn-sm btn-secondary expand-button">ë”ë³´ê¸°</button>
                    <!-- ê²Œì‹œë¬¼ ë‚´ìš©ì˜ ì ‘ê¸° ë²„íŠ¼(ì´ˆê¸°ì—ëŠ” ìˆ¨ê²¨ë‘ ) -->
                    <button class="btn btn-sm btn-secondary collapse-button" style="display: none;">ì ‘ê¸°</button>
                    

                    {% if post.content_type == 'review' and post.product %}
                        <hr>
                        <h5>ì œí’ˆ ë¦¬ë·°</h5>
                        <p>ì œí’ˆëª…: {{ post.product.name }}</p>
                        <p>íŒë§¤ì: {{ post.seller.username }}</p>
                    {% endif %}
                </div>
                <div class="card-footer text-muted">
                    <p> {{ post.created_at|date:"Y-m-d H:i" }} </p>
                  </div>
                </div>
              <!-- ëŒ“ê¸€ ì „ì²´ í‘œì‹œ -->
              <div class="modal-header">
                <h5 class="modal-title">ëŒ“ê¸€ ì…ë ¥</h5>
                
            </div>
            <div class="modal-body">
                <form id="comment-form" action="{% url 'feed:comments_create' post.id %}" method="post">
                    {% csrf_token %}
                    <textarea class="form-control" id="comment-text" name="comment_text" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <button type="submit" class="btn btn-primary mt-3">ì‘ì„±</button>
                </form>
            </div>
            

<!-- ëŒ“ê¸€ë“¤ -->
<div class="">
    {% if most_liked_comment %}
    <div class="comment-container">
        <div class="comment-header">
            <h6>{{ most_liked_comment.user.username }}</h6>
            <div class="comment-actions row justify-content-between">
                <div class="col-auto">
                    {% if request.user == most_liked_comment.user or request.user.is_staff %}
                    <form action="{% url 'feed:comments_delete' most_liked_comment.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link">ì‚­ì œ</button>
                    </form>
                    {% endif %}
                </div>
                <div class="col-auto">
                    {% if request.user == most_liked_comment.user or request.user.is_staff %}
                    <a href="{% url 'feed:comments_update' most_liked_comment.pk %}" class="btn btn-secondary">ìˆ˜ì •</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <p>{{ most_liked_comment.comment_text }}</p>
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
        <div class="row justify-content-between align-items-center">
            <div class="col-auto">
                <span class="like-count">ì¢‹ì•„ìš”({{ most_liked_comment.likes.count }})</span> <!-- ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œ -->
            </div>
            <div class="col-auto">
                <button class="like-btn btn-primary" data-comment-id="{{ most_liked_comment.pk }}">
                    {% if request.user.is_authenticated %}
                    {% if request.user in most_liked_comment.likes.all %}
                    <i class="fas fa-heart text-danger"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° -->
                    {% else %}
                    <i class="far fa-heart text-secondary"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš° -->
                    {% endif %}
                    {% else %}
                    <i class="far fa-heart text-secondary"></i> <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                    {% endif %}
                </button>
            </div>
        </div>
        <!-- ìˆ˜ì •ë˜ë©´ ìˆ˜ì •í‘œì‹œ ë‚˜íƒ€ëƒ„ -->
        <p class="comment-date">
            ì‘ì„±ì¼ì‹œ: {{ most_liked_comment.created_at }}
            {% if most_liked_comment.created_at != most_liked_comment.updated_at %}
            (ìˆ˜ì •ë¨)
            {% endif %}
        </p>
    </div>
    {% endif %}

    <!-- ë‚˜ë¨¸ì§€ ëŒ“ê¸€ë“¤ -->
    {% for comment in other_comments %}
    <div class="comment-container {% if forloop.counter > 1 %}hidden{% endif %}">
        <div class="comment-header">
            <h6>{{ comment.user.username }}</h6>
            <div class="comment-actions row justify-content-between">
                <div class="col-auto">
                    {% if request.user == comment.user or request.user.is_staff %}
                    <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link">ì‚­ì œ</button>
                    </form>
                    {% endif %}
                </div>
                <div class="col-auto">
                    {% if request.user == comment.user or request.user.is_staff %}
                    <a href="{% url 'feed:comments_update' comment.pk %}" class="btn btn-secondary">ìˆ˜ì •</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <p>{{ comment.comment_text }}</p>
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
        <div class="row justify-content-between align-items-center">
            <div class="col-auto">
                <span class="like-count">ì¢‹ì•„ìš”({{ comment.likes.count }})</span> <!-- ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œ -->
            </div>
            <div class="col-auto">
                <button class="like-btn" data-comment-id="{{ comment.pk }}">
                    {% if request.user.is_authenticated %}
                    {% if request.user in comment.likes.all %}
                    <i class="fas fa-heart text-danger"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° -->
                    {% else %}
                    <i class="far fa-heart text-secondary"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš° -->
                    {% endif %}
                    {% else %}
                    <i class="far fa-heart text-secondary"></i> <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                    {% endif %}
                </button>
            </div>
        </div>
        <!-- ìˆ˜ì •ë˜ë©´ ìˆ˜ì •í‘œì‹œ ë‚˜íƒ€ëƒ„ -->
        <p class="comment-date">
            ì‘ì„±ì¼ì‹œ: {{ comment.created_at }}
            {% if comment.created_at != comment.updated_at %}
            (ìˆ˜ì •ë¨)
            {% endif %}
        </p>
    </div>
    {% empty %}
    <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
</div>


            
            


              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- ----------------- ëª¨ë‹¬ ìƒì„± ë ------------------------------  -->

      <!-- ì¢‹ì•„ìš”ê°€ ë§ì€ ëŒ“ê¸€ë§Œ í‘œì‹œ -->
      {% if most_liked_comment %}
      <div class="comment-container">
          <!-- ìµœê³  ì¢‹ì•„ìš”ë¥¼ ë°›ì€ ëŒ“ê¸€ í‘œì‹œ -->
          <div class="comment-header">
              <h6>{{ most_liked_comment.user.username }}</h6>
              <div class="comment-actions row justify-content-between">
                  <div class="col-auto">
                      {% if request.user == most_liked_comment.user or request.user.is_staff %}
                          <form action="{% url 'feed:comments_delete' most_liked_comment.pk %}" method="post" class="d-inline">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-link">ì‚­ì œ</button>
                          </form>
                      {% endif %}
                  </div>
                  <div class="col-auto">
                      {% if request.user == most_liked_comment.user or request.user.is_staff %}
                          <a href="{% url 'feed:comments_update' most_liked_comment.pk %}" class="btn btn-secondary">ìˆ˜ì •</a>
                      {% endif %}
                  </div>
              </div>
          </div>
          <p>{{ most_liked_comment.comment_text }}</p>
          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
          <div class="row align-items-center">
              <div class="col-auto">
                  <button class="like-btn btn-primary" data-comment-id="{{ most_liked_comment.pk }}">
                      {% if request.user.is_authenticated %}
                          {% if request.user in most_liked_comment.likes.all %}
                              <i class="fas fa-heart text-danger"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° -->
                          {% else %}
                              <i class="far fa-heart text-secondary"></i> <!-- ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš° -->
                          {% endif %}
                      {% else %}
                          <i class="far fa-heart text-secondary"></i> <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° -->
                      {% endif %}
                  </button>
              </div>
              <div class="col-auto">
                  <span class="like-count">ì¢‹ì•„ìš”({{ most_liked_comment.likes.count }})</span> <!-- ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œ -->
              </div>
              <div class="col-auto">
                  <p class="comment-date">ì‘ì„±ì¼ì‹œ: {{ most_liked_comment.created_at }}</p>
                  {% if most_liked_comment.created_at != most_liked_comment.updated_at %}
                      <p class="comment-date">(ìˆ˜ì •ë¨)</p>
                  {% endif %}
              </div>
          </div>
      </div>
  {% else %}
      <!-- ëŒ“ê¸€ì´ ì—†ì„ ë•Œ í‘œì‹œ -->
      <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
  
      
      <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#commentWidgetModal">
        ëŒ“ê¸€ ë³´ê¸°
      </button>
    </div>
  </div>
</div>

<!-- AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ ì¢‹ì•„ìš” ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” JavaScript ì½”ë“œ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.querySelectorAll('.like-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        var commentId = this.getAttribute('data-comment-id');
        var likeCount = this.closest('.row').querySelector('.like-count');
        var heartIcon = this.querySelector('i'); // í•˜íŠ¸ ì•„ì´ì½˜

        // AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë¡œ ì¢‹ì•„ìš” ìš”ì²­ì„ ë³´ëƒ„
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/feed/comment_like/' + commentId + '/');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onload = function() {
          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            // ì„œë²„ë¡œë¶€í„° ì¢‹ì•„ìš” ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ìœ¼ë©´ ì¢‹ì•„ìš” ìˆ«ìë¥¼ ì—…ë°ì´íŠ¸
            likeCount.textContent ='ì¢‹ì•„ìš”(' + response.likes_count + ')';

            // ì¢‹ì•„ìš” ë²„íŠ¼ì˜ ì•„ì´ì½˜ ë³€ê²½
            if (response.liked) {
              heartIcon.classList.remove('far'); // ë¹ˆ í•˜íŠ¸ í´ë˜ìŠ¤ ì œê±°
              heartIcon.classList.add('fas');  // ì±„ì›Œì§„ í•˜íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
              heartIcon.classList.add('text-danger'); // í•˜íŠ¸ ìƒ‰ìƒ ë³€ê²½
            } else {
              heartIcon.classList.remove('fas'); // ì±„ì›Œì§„ í•˜íŠ¸ í´ë˜ìŠ¤ ì œê±°
              heartIcon.classList.add('far');  // ë¹ˆ í•˜íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
              heartIcon.classList.remove('text-danger'); // í•˜íŠ¸ ìƒ‰ìƒ ì œê±°
            }
          } else {
            console.error('Request failed. Error: ' + xhr.status);
          }
        };
        xhr.send(JSON.stringify({}));
      });
    });
  });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.querySelectorAll('.expand-button, .collapse-button').forEach(function(button) {
            button.addEventListener('click', function() {
                var postBody = this.closest('.card-body').querySelector('.post-body');
                postBody.classList.toggle('collapsed');
                postBody.classList.toggle('expand');
                // ë”ë³´ê¸° ë²„íŠ¼ê³¼ ì ‘ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
                this.closest('.card-body').querySelector('.expand-button').style.display = postBody.classList.contains('collapsed') ? 'inline-block' : 'none';
                this.closest('.card-body').querySelector('.collapse-button').style.display = postBody.classList.contains('expand') ? 'inline-block' : 'none';
            });
        });
    });
    </script>
    
    
    
    
    

{% endblock %}
