{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
      /* 게시물 내용이 3줄 이상인 경우에만 더보기/접기 버튼 표시 */
      .post-body.collapsed {
        max-height: 60px; /* 최대 높이 설정 */
        overflow: hidden; /* 초과 내용 숨김 */
    }
  /* ------------------ */
  #comment-text {
    resize: none;
}

/* ------------------ */
/* 댓글 섹션 스타일 */
.comment-section {
    margin-top: 20px;
}

/* 댓글 컨테이너 스타일 */
.comment-container {
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
}

/* 댓글 헤더 스타일 */
.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

/* 사용자 이름 스타일 */
.comment-header h6 {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
}

/* 댓글 내용 스타일 */
.comment-container p {
    margin-bottom: 10px;
    font-size: 16px;
}

/* 좋아요 버튼 및 개수 스타일 */
.like-count {
    font-size: 14px;
    color: #777;
    margin-right: 10px;
}

.like-btn {
    background-color: transparent;
    border: none;
    cursor: pointer;
    outline: none;
}

/* 작성일 및 수정 여부 스타일 */
.comment-date {
    font-size: 12px;
    color: #999;
}

/* 좋아요 버튼 스타일 */
.like-btn i {
    font-size: 18px;
    margin-right: 5px;
}

/* 드롭다운 아이콘 스타일 */
.edit-delete-icon {
    color: #777;
    cursor: pointer;
}

/* 드롭다운 메뉴 스타일 */
.dropdown-menu {
    min-width: 150px;
}

.dropdown-menu a {
    color: #333;
}

.dropdown-menu button {
    color: #333;
}

  /* ------------------ */
  .btn.dropdown-toggle::after {
  content: none; /* 화살표 제거 */
  }
  .btn.dropdown-toggle::before {
  content: "..."; /* 점 세 개 추가 */
  font-size: 1.2rem; /* 점 세 개 크기 조정 */
  color: #333; /* 점 세 개 색상 조정 */
  }
  .edit-delete-buttons {
    position: absolute; /* 절대 위치 지정 */
    top: 35px; /* 상단에서 n px 떨어진 곳에 위치 */
    right: 0px; /* 오른쪽에서 n px 떨어진 곳에 위치 */
    z-index: 2; /* 이미지 위에 표시되도록 z-index 설정 */
  }


  .edit-delete-buttons {
    float: right; /* 오른쪽 정렬 */
    margin-top: -35px; /* 버튼을 카드 상단 쪽으로 옮기기 */
  }
  .custom-card {
    max-width: 600px; 
    margin: auto; 
  }
  .carousel-item .feed-image {
    object-fit: contain;
    width: 100%;
    height: 500px;
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  .no-underline {
    text-decoration: none; 
  }
  .comment-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  .comment-actions {
    display: flex;
    gap: 10px;
  }
  .comment-actions button {
    background-color: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
  }
  .carousel-control-next-icon,
  .carousel-control-prev-icon {
    filter: invert(1);
  }
</style>
<div class="container mt-5">
  <div class="card custom-card" style="position: relative;"> <!-- 상대 위치 지정 -->
    {% if post.feed_images.all %}
      <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
        <div class="carousel-inner">
          {% for image in post.feed_images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
            </div>
          {% endfor %}
        </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
          </button>
        </div>
      {% endif %}
        

      <div class="card-body">
        <div class="mb-3">
            <div class="d-flex align-items-center">
                {% if post.user.profile.user_image %}
                    <a href="{% url 'feed:view_user' pk=post.user.pk %}" class="me-2">
                        <img src="{{post.user.profile.user_image.url}}" class="rounded-circle" style="width: 40px; height: 40px;">
                    </a>
                {% else %}
                    <a href="{% url 'feed:view_user' pk=post.user.pk %}" class="me-2">
                        <img src="{% static 'default_profile_pic.png' %}" class="rounded-circle" style="width: 40px; height: 40px;">
                    </a>
                {% endif %}
                <h2><a href="{% url 'feed:view_user' pk=post.user.pk %}">{{ post.user.username }}</a></h2>
            </div>
        </div>
        <h2>{{ post.title }}</h2>
        <p class="mt-3">{{ post.body_text }}</p>
          <div class="d-flex justify-content-between align-items-end">
              <div>
                  <!-- 좋아요 버튼 수정 -->
                  <a href="#" class="no-underline like-button" data-post="{{ post.id }}">
                      {% if user in post.likes.all %}
                          <span class="likes-count">❤️</span>
                      {% else %}
                          <span class="likes-count">🤍</span>
                      {% endif %}
                  </a>
                  : <span class="likes-count">{{ post.likes.count }}</span>
              </div>
              <div>
                  <small class="text-muted d-block">작성: {{ post.created_at|date:"Y-m-d H:i" }}</small>
                  {% if post.updated_at|date:"U" != post.created_at|date:"U" %}
                      <small class="text-muted d-block">수정: {{ post.updated_at|date:"Y-m-d H:i" }}</small>
                  {% endif %}
              </div>
          </div>


        {% if post.content_type == 'review' and post.product %}
          <hr>
          <h5>제품 리뷰</h5>
          <p>제품명: {{ post.product.name }}</p>
          <p>판매자: {{ post.seller.username }}</p>
        {% endif %}
        
        <!-- 게시글에 대한 수정 삭제 버튼, 드롭다운 메뉴 형태로 표시 -->
        {% if request.user == post.user or request.user.is_staff %}
        <div class="edit-delete-buttons">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
            </button>            
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
              <li><a class="dropdown-item" href="{% url 'feed:post_edit' post.pk %}">수정</a></li>
              <li>
                <form action="{% url 'feed:post_delete' post.id %}" method="post" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">삭제</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
        {% endif %}

<!-- -------------------------------------------------- -->

      <!-- ----------------- 모달 사용하여 위젯 생성------------------------------  -->
      <div class="modal fade" id="commentWidgetModal" tabindex="-1" aria-labelledby="commentWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="commentWidgetModalLabel">댓글({{comments_count}})</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card-body">
                    <h2><a href="{% url 'feed:view_user' post.user.id %}">{{ post.user.username }}</a></h2>
                    <h2>{{ post.title }}</h2>
                    <p class="mt-3 post-body collapsed">{{ post.body_text }}</p>
                    <!-- 게시물 내용의 더보기 버튼 -->
                    <button class="btn btn-sm btn-secondary expand-button">더보기</button>
                    <!-- 게시물 내용의 접기 버튼(초기에는 숨겨둠) -->
                    <button class="btn btn-sm btn-secondary collapse-button" style="display: none;">접기</button>
                    

                    {% if post.content_type == 'review' and post.product %}
                        <hr>
                        <h5>제품 리뷰</h5>
                        <p>제품명: {{ post.product.name }}</p>
                        <p>판매자: {{ post.seller.username }}</p>
                    {% endif %}
                </div>
                <div class="card-footer text-muted">
                    <p> {{ post.created_at|date:"Y-m-d H:i" }} </p>
                  </div>
                </div>
              <!-- 댓글 전체 표시 -->
              <div class="modal-header">
                <h5 class="modal-title">댓글 입력</h5>
                
            </div>
            <div class="modal-body">
              <form id="comment-form" action="{% url 'feed:comments_create' post.id %}" method="post" onsubmit="return validateComment()">
                {% csrf_token %}
                <textarea class="form-control" id="comment-text" name="comment_text" rows="3" placeholder="댓글을 입력하세요..."></textarea>
                <button type="submit" class="btn btn-primary mt-3">작성</button>
            </form>
          </div>
            

<!-- 댓글들 -->

<div class="comment-section">
  {% if most_liked_comment %}
  <!-- 최고 좋아요를 받은 댓글 -->
  <div class="comment-container">
      <div class="comment-header d-flex justify-content-between align-items-center">
          <div>
              <h6>{{ most_liked_comment.user.username }}</h6>
              <p>{{ most_liked_comment.comment_text }}</p>
              <div class="row align-items-center">
                  <div class="col-auto">
                      <button class="like-btn btn-primary" data-comment-id="{{ most_liked_comment.pk }}">
                          {% if request.user.is_authenticated %}
                              {% if request.user in most_liked_comment.likes.all %}
                                  <i class="fas fa-heart text-danger"></i> <!-- 좋아요를 누른 경우 -->
                              {% else %}
                                  <i class="far fa-heart text-secondary"></i> <!-- 좋아요를 누르지 않은 경우 -->
                              {% endif %}
                          {% else %}
                              <i class="far fa-heart text-secondary"></i> <!-- 로그인하지 않은 경우 -->
                          {% endif %}
                      </button>
                  </div>
                  <div class="col-auto">
                      <span class="like-count">좋아요({{ most_liked_comment.likes.count }})</span> <!-- 좋아요 개수 표시 -->
                  </div>
              </div>
              <div class="comment-date">
                  <p>{{ most_liked_comment.created_at }}
                      {% if most_liked_comment.created_at != most_liked_comment.updated_at %}
                          (수정됨)
                      {% endif %}
                  </p>
              </div>
          </div>
          <div class="comment-actions">
            {% if request.user == most_liked_comment.user or request.user.is_staff %}
              <div class="dropdown">
                  <button class="btn btn-link dropdown-toggle-1 p-0 edit-delete-icon" type="button" id="dropdownMenuButton{{ most_liked_comment.pk }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fas fa-ellipsis-v fa-lg"></i>
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ most_liked_comment.pk }}">
                      {% if request.user == most_liked_comment.user or request.user.is_staff %}
                      <form action="{% url 'feed:comments_delete' most_liked_comment.pk %}" method="post" class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="dropdown-item trash-icon"><i class="fas fa-trash-alt fa-lg"></i> 삭제</button>
                      </form>
                      {% endif %}
                      {% if request.user == most_liked_comment.user or request.user.is_staff %}
                      <a href="{% url 'feed:comments_update' most_liked_comment.pk %}" class="dropdown-item edit-icon"><i class="fas fa-edit fa-lg"></i> 수정</a>
                      {% endif %}
                  </div>
              </div>
            {% endif %}
          </div>
      </div>
      
  </div>
  {% else %}
  <!-- 댓글이 없을 때 표시 -->
  <p>댓글이 없습니다.</p>
  {% endif %}

  <!-- 나머지 댓글들 -->
  {% for comment in other_comments %}
  <div class="comment-container">
      <div class="comment-header d-flex justify-content-between align-items-center">
          <div>
              <h6>{{ comment.user.username }}</h6>
              <p>{{ comment.comment_text }}</p>
              <div class="row align-items-center">
                  <div class="col-auto">
                      <button class="like-btn" data-comment-id="{{ comment.pk }}">
                          {% if request.user.is_authenticated %}
                              {% if request.user in comment.likes.all %}
                                  <i class="fas fa-heart text-danger"></i> <!-- 좋아요를 누른 경우 -->
                              {% else %}
                                  <i class="far fa-heart text-secondary"></i> <!-- 좋아요를 누르지 않은 경우 -->
                              {% endif %}
                          {% else %}
                              <i class="far fa-heart text-secondary"></i> <!-- 로그인하지 않은 경우 -->
                          {% endif %}
                      </button>
                  </div>
                  <div class="col-auto">
                      <span class="like-count">좋아요({{ comment.likes.count }})</span> <!-- 좋아요 개수 표시 -->
                  </div>
              </div>
              <div class="comment-date">
                  <p>{{ comment.created_at }}
                      {% if comment.created_at != comment.updated_at %}
                          (수정됨)
                      {% endif %}
                  </p>
              </div>
          </div>
          <div class="comment-actions">
            {% if request.user == comment.user or request.user.is_staff %}            
              <div class="dropdown">
                  <button class="btn btn-link dropdown-toggle-1 p-0 edit-delete-icon" type="button" id="dropdownMenuButton{{ comment.pk }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fas fa-ellipsis-v fa-lg"></i>
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ comment.pk }}">
                      {% if request.user == comment.user or request.user.is_staff %}
                      <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="dropdown-item trash-icon"><i class="fas fa-trash-alt fa-lg"></i> 삭제</button>
                      </form>
                      {% endif %}
                      {% if request.user == comment.user or request.user.is_staff %}
                      <a href="{% url 'feed:comments_update' comment.pk %}" class="dropdown-item edit-icon"><i class="fas fa-edit fa-lg"></i> 수정</a>
                      {% endif %}
                  </div>
              </div>
            {% endif %}
          </div>
      </div>
      
  </div>
  {% endfor %}
</div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- ----------------- 모달 생성 끝 ------------------------------  -->

      <!-- 게시글 댓글에서 좋아요가 많은 댓글만 표시 -->
      {% if most_liked_comment %}
      <div class="comment-container">
          <!-- 최고 좋아요를 받은 댓글 표시 -->
          <div class="comment-header">
              <h6>{{ most_liked_comment.user.username }}</h6>
              <div class="comment-actions row justify-content-between align-items-center">
                  <div class="col-auto">
                    {% if request.user == most_liked_comment.user or request.user.is_staff %}
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle-1 p-0 edit-delete-icon" type="button" id="dropdownMenuButton{{ most_liked_comment.pk }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-lg"></i>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ most_liked_comment.pk }}">
                            {% if request.user == most_liked_comment.user or request.user.is_staff %}
                            <form action="{% url 'feed:comments_delete' most_liked_comment.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item trash-icon"><i class="fas fa-trash-alt fa-lg"></i> 삭제</button>
                            </form>
                            {% endif %}
                            {% if request.user == most_liked_comment.user or request.user.is_staff %}
                            <a href="{% url 'feed:comments_update' most_liked_comment.pk %}" class="dropdown-item edit-icon"><i class="fas fa-edit fa-lg"></i> 수정</a>
                            {% endif %}
                        </div>
                    </div>
                  {% endif %}
                  </div>
              </div>
          </div>
          <p>{{ most_liked_comment.comment_text }}</p>
          <!-- 좋아요 버튼 -->
          <div class="row align-items-center">
              <div class="col-auto">
                  <button class="like-btn btn-primary" data-comment-id="{{ most_liked_comment.pk }}">
                      {% if request.user.is_authenticated %}
                      {% if request.user in most_liked_comment.likes.all %}
                      <i class="fas fa-heart text-danger"></i> <!-- 좋아요를 누른 경우 -->
                      {% else %}
                      <i class="far fa-heart text-secondary"></i> <!-- 좋아요를 누르지 않은 경우 -->
                      {% endif %}
                      {% else %}
                      <i class="far fa-heart text-secondary"></i> <!-- 로그인하지 않은 경우 -->
                      {% endif %}
                  </button>
              </div>
              <div class="col-auto">
                  <span class="like-count">좋아요({{ most_liked_comment.likes.count }})</span> <!-- 좋아요 개수 표시 -->
              </div>
              <div class="col-auto">
                  <p class="comment-date">작성일시: {{ most_liked_comment.created_at }}</p>
                  {% if most_liked_comment.created_at != most_liked_comment.updated_at %}
                  <p class="comment-date">(수정됨)</p>
                  {% endif %}
              </div>
          </div>
      </div>
      {% else %}
      <!-- 댓글이 없을 때 표시 -->
      <p>댓글이 없습니다.</p>
      {% endif %}
      

      <!-- 더보기 버튼 -->
      <div class="bg_lm">
        <button type="button" class="bg_lp btn btn-light border" aria-label="댓글 보러 가기" data-bs-toggle="modal" data-bs-target="#commentWidgetModal">
          <div class="bg_c7 t5">댓글 ({{ comments_count }})개 보기</div>
        </button>
      </div>
      
    </div>
  </div>
</div>
<!-- --------------------------------------------------------------------------- -->
<script>
// Django에서 제공하는 CSRF 토큰 가져오기
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

document.addEventListener("DOMContentLoaded", function(){
  const likeButtons = document.querySelectorAll('.like-button');
  
  likeButtons.forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const postId = this.dataset.post; 
      console.log(csrftoken);

      fetch(`{%url "feed:like-content" post.id%}`, {
        method: 'POST',
        
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          'postId': postId,
        })
      })
      .then(response => response.json())
      .then(data => {
        const likeButton = this;
        const likesCountElement = likeButton.querySelector('.likes-count');
        likesCountElement.innerText = data.is_liked ? '❤️' : '🤍';
        likeButton.nextElementSibling.innerText = data.likes_count;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    });
  });
});
</script>
<!-- -------------------------------------------------------------------------------------- -->
<!-- AJAX를 사용하여 좋아요 요청을 보내고 응답을 처리하는 JavaScript 코드 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 좋아요 버튼 클릭 이벤트 처리
    document.querySelectorAll('.like-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        var commentId = this.getAttribute('data-comment-id');
        var likeCount = this.closest('.row').querySelector('.like-count');
        var heartIcon = this.querySelector('i'); // 하트 아이콘

        // AJAX를 사용하여 서버로 좋아요 요청을 보냄
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/feed/comment_like/' + commentId + '/');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onload = function() {
          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            // 서버로부터 좋아요 요청에 대한 응답을 받으면 좋아요 숫자를 업데이트
            likeCount.textContent ='좋아요(' + response.likes_count + ')';

            // 좋아요 버튼의 아이콘 변경
            if (response.liked) {
              heartIcon.classList.remove('far'); // 빈 하트 클래스 제거
              heartIcon.classList.add('fas');  // 채워진 하트 클래스 추가
              heartIcon.classList.add('text-danger'); // 하트 색상 변경
            } else {
              heartIcon.classList.remove('fas'); // 채워진 하트 클래스 제거
              heartIcon.classList.add('far');  // 빈 하트 클래스 추가
              heartIcon.classList.remove('text-danger'); // 하트 색상 제거
            }
          } else {
            console.error('Request failed. Error: ' + xhr.status);
          }
        };
        xhr.send(JSON.stringify({}));
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // 더보기/접기 버튼 클릭 이벤트 처리
      document.querySelectorAll('.expand-button, .collapse-button').forEach(function(button) {
          button.addEventListener('click', function() {
              var postBody = this.closest('.card-body').querySelector('.post-body');
              postBody.classList.toggle('collapsed');
              postBody.classList.toggle('expand');
              // 더보기 버튼과 접기 버튼 표시/숨김 처리
              this.closest('.card-body').querySelector('.expand-button').style.display = postBody.classList.contains('collapsed') ? 'inline-block' : 'none';
              this.closest('.card-body').querySelector('.collapse-button').style.display = postBody.classList.contains('expand') ? 'inline-block' : 'none';
          });
      });

      // 각 게시물 내용의 높이를 확인하여 더보기/접기 버튼을 자동으로 처리하는 함수 호출
      autoTogglePostBody();
  });

  // 게시물 내용의 높이를 확인하여 더보기/접기 버튼을 자동으로 처리하는 함수 정의
  function autoTogglePostBody() {
      document.querySelectorAll('.card-body .post-body').forEach(function(postBody) {
          // 게시물 내용의 높이를 확인하여 더보기/접기 버튼 자동 처리
          if (postBody.clientHeight > 60) { // 게시물 내용의 높이가 3줄 이상인 경우
              postBody.classList.add('collapsed'); // 접힌 상태로 설정
              postBody.nextElementSibling.style.display = 'inline-block'; // 더보기 버튼 표시
          } else {
              postBody.nextElementSibling.style.display = 'none'; // 더보기 버튼 숨김
          }
      });
  }
</script>

    <!-- 수정,삭제 ...아이콘에 넣기 -->
<script>
  // 아이콘 클릭 이벤트 처리
  document.addEventListener('DOMContentLoaded', function() {
      var editDeleteIcons = document.querySelectorAll('.edit-delete-icon');
      editDeleteIcons.forEach(function(icon) {
          icon.addEventListener('click', function(event) {
              event.stopPropagation(); // 이벤트 전파 방지

              // 현재 클릭한 아이콘의 드롭다운 메뉴를 토글
              var dropdownMenu = this.nextElementSibling;
              if (dropdownMenu.style.display === 'none' || dropdownMenu.style.display === '') {
                  dropdownMenu.style.display = 'block';
              } else {
                  dropdownMenu.style.display = 'none';
              }
          });
      });
  });
</script>
<script>
  function validateComment() {
      var commentText = document.getElementById('comment-text').value.trim();
      if (commentText === '') {
          alert('댓글을 입력하세요.');
          return false;  // 댓글이 비어있으면 전송을 중지하고 알림을 표시합니다.
      }
      return true;  // 댓글이 작성되었으면 전송을 계속합니다.
  }
</script>
<!-- ---------------------------------------------------------------- -->
{% endblock %}
