{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .btn.dropdown-toggle::after {
  content: none; /* 화살표 제거 */
  }
  .btn.dropdown-toggle::before {
  content: "..."; /* 점 세 개 추가 */
  font-size: 1.2rem; /* 점 세 개 크기 조정 */
  color: #333; /* 점 세 개 색상 조정 */
  }
  .edit-delete-buttons {
    position: absolute; /* 절대 위치 지정 */
    top: 35px; /* 상단에서 n px 떨어진 곳에 위치 */
    right: 0px; /* 오른쪽에서 n px 떨어진 곳에 위치 */
    z-index: 2; /* 이미지 위에 표시되도록 z-index 설정 */
  }
  .btn {
  width: auto; /* 버튼 너비를 자동으로 설정 */
  height: 25px; /* 버튼 높이 40px */
  line-height: 0px; /* 텍스트를 수직 중앙 정렬 */
  background-color: white; /* 버튼 배경색을 흰색으로 변경 */
  }
  .edit-delete-buttons {
    float: right; /* 오른쪽 정렬 */
    margin-top: -35px; /* 버튼을 카드 상단 쪽으로 옮기기 */
  }
  .custom-card {
    max-width: 600px; 
    margin: auto; 
  }
  .carousel-item .feed-image {
    object-fit: contain;
    width: 100%;
    height: 500px;
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  .no-underline {
    text-decoration: none; 
  }
  .comment-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  .comment-actions {
    display: flex;
    gap: 10px;
  }
  .comment-actions button {
    background-color: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
  }
  .btn-primary {
    background-color: #007bff; /* 버튼 배경색을 파란색으로 변경 */
    color: white; /* 버튼 글씨 색을 흰색으로 변경 */
  }
  .carousel-control-next-icon,
  .carousel-control-prev-icon {
    filter: invert(1);
  }
</style>
<div class="container mt-5">
  <div class="card custom-card" style="position: relative;"> <!-- 상대 위치 지정 -->
    {% if post.feed_images.all %}
      <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
        <div class="carousel-inner">
          {% for image in post.feed_images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
            </div>
          {% endfor %}
        </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
          </button>
        </div>
      {% endif %}

      <div class="card-body">
        <div class="mb-3">
            <div class="d-flex align-items-center">
                {% if post.user.profile.user_image %}
                    <a href="{% url 'feed:view_user' pk=post.user.pk %}" class="me-2">
                        <img src="{{post.user.profile.user_image.url}}" class="rounded-circle" style="width: 40px; height: 40px;">
                    </a>
                {% else %}
                    <a href="{% url 'feed:view_user' pk=post.user.pk %}" class="me-2">
                        <img src="{% static 'default_profile_pic.png' %}" class="rounded-circle" style="width: 40px; height: 40px;">
                    </a>
                {% endif %}
                <h2><a href="{% url 'feed:view_user' pk=post.user.pk %}">{{ post.user.username }}</a></h2>
            </div>
        </div>
        <h2>{{ post.title }}</h2>
        <p class="mt-3">{{ post.body_text }}</p>
          <div class="d-flex justify-content-between align-items-end">
              <div>
                  <!-- 좋아요 버튼 수정 -->
                  <a href="#" class="no-underline like-button" data-post="{{ post.id }}">
                      {% if user in post.likes.all %}
                          <span class="likes-count">❤️</span>
                      {% else %}
                          <span class="likes-count">🤍</span>
                      {% endif %}
                  </a>
                  : <span class="likes-count">{{ post.likes.count }}</span>
              </div>
              <div>
                  <small class="text-muted d-block">작성: {{ post.created_at|date:"Y-m-d H:i" }}</small>
                  {% if post.updated_at|date:"U" != post.created_at|date:"U" %}
                      <small class="text-muted d-block">수정: {{ post.updated_at|date:"Y-m-d H:i" }}</small>
                  {% endif %}
              </div>
          </div>
      </div>

        {% if post.content_type == 'review' and post.product %}
          <hr>
          <h5>제품 리뷰</h5>
          <p>제품명: {{ post.product.name }}</p>
          <p>판매자: {{ post.seller.username }}</p>
        {% endif %}
        
        <!-- 게시글에 대한 수정 삭제 버튼, 드롭다운 메뉴 형태로 표시 -->
        {% if request.user == post.user or request.user.is_staff %}
        <div class="edit-delete-buttons">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
            </button>            
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
              <li><a class="dropdown-item" href="{% url 'feed:post_edit' post.pk %}">수정</a></li>
              <li>
                <form action="{% url 'feed:post_delete' post.id %}" method="post" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">삭제</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
        {% endif %}



      <div class="card-footer">
        <h5>댓글</h5>
        {% for comment in post.comment_set.all %}
        <div class="comment-container">
          <div class="comment-header">
            <h6>{{ comment.user.username }}</h6>
            <div class="comment-actions">
              <p>{{ comment.created_at }}</p>
              {% if request.user == comment.user or request.user.is_staff %}
              <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit">삭제</button>
              </form>
              {% endif %}
            </div>
          </div>
          <p>{{ comment.comment_text }}</p>
        </div>
        {% empty %}
        <p>댓글이 없습니다.</p>
        {% endfor %}
        
        <form action="{% url 'feed:comments_create' post.id %}" method="post">
          {% csrf_token %}
          {{ commentform }}
          <button type="submit" class="btn btn-primary">작성</button>
        </form>
      </div>
    </div>
</div>
<script>
// Django에서 제공하는 CSRF 토큰 가져오기
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

document.addEventListener("DOMContentLoaded", function(){
  const likeButtons = document.querySelectorAll('.like-button');
  
  likeButtons.forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const postId = this.dataset.post; 
      console.log(csrftoken);

      fetch(`{%url "feed:like-content" post.id%}`, {
        method: 'POST',
        
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          'postId': postId,
        })
      })
      .then(response => response.json())
      .then(data => {
        const likeButton = this;
        const likesCountElement = likeButton.querySelector('.likes-count');
        likesCountElement.innerText = data.is_liked ? '❤️' : '🤍';
        likeButton.nextElementSibling.innerText = data.likes_count;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    });
  });
});
</script>
{% endblock %}
